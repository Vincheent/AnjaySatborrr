import React, { useState, useRef } from 'react';
import { Unlock, Copy, Check, AlertCircle, Upload, FileText, Download } from 'lucide-react';

export default function LuaDecryptTool() {
  const [output, setOutput] = useState('');
  const [error, setError] = useState('');
  const [copied, setCopied] = useState(false);
  const [processing, setProcessing] = useState(false);
  const [fileName, setFileName] = useState('');
  const [fileSize, setFileSize] = useState(0);
  const [decryptInfo, setDecryptInfo] = useState(null);
  const fileInputRef = useRef(null);

  const decryptLua = (text) => {
    try {
      // Extract key
      const keyMatch = text.match(/local\s+key\s*=\s*\[\[(.*?)\]\];/s);
      if (!keyMatch) {
        throw new Error('Key tidak ditemukan. Pastikan ada format: local key = [[...]];');
      }
      const key = keyMatch[1];

      // Extract encrypted data
      const dataMatch = text.match(/"Encrypt By Yasu";\s*([a-zA-Z0-9]+)\s*=\s*\{\s*([0-9,\s]+?)\s*\}.*?then\s*_ENV\["\\108\\111\\97\\100"\]/s);
      if (!dataMatch) {
        throw new Error('Data terenkripsi tidak ditemukan. Pastikan ada "Encrypt By Yasu" dan format yang benar');
      }
      
      const encryptedData = dataMatch[2];
      const numbers = encryptedData.match(/\d+/g);
      
      if (!numbers || numbers.length === 0) {
        throw new Error('Tidak ada data angka yang ditemukan');
      }
      
      const numArray = numbers.map(x => parseInt(x));
      
      // Decrypt
      const keyChars = key.split('').map(c => c.charCodeAt(0));
      let keyIndex = 0;
      
      const decrypted = numArray.map(num => {
        const keyChar = keyChars[keyIndex % keyChars.length];
        keyIndex++;
        return String.fromCharCode((num - keyChar + 256) % 256);
      }).join('');

      if (!decrypted || decrypted.length === 0) {
        throw new Error('Hasil dekripsi kosong');
      }

      return { result: decrypted, keyLength: key.length, dataCount: numArray.length };
    } catch (err) {
      throw new Error(err.message || 'Gagal mendekripsi script');
    }
  };

  const handleFileUpload = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    setFileName(file.name);
    setFileSize(file.size);
    setError('');
    setOutput('');
    setCopied(false);
    setDecryptInfo(null);
    setProcessing(true);

    try {
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const { result, keyLength, dataCount } = decryptLua(text);
          setOutput(result);
          setDecryptInfo({
            keyLength,
            dataCount,
            inputSize: file.size,
            outputSize: result.length
          });
          setProcessing(false);
        } catch (err) {
          setError(err.message);
          setProcessing(false);
        }
      };
      
      reader.onerror = () => {
        setError('Gagal membaca file. Coba lagi.');
        setProcessing(false);
      };
      
      reader.readAsText(file, 'utf-8');
    } catch (err) {
      setError('Gagal membaca file: ' + err.message);
      setProcessing(false);
    }
  };

  const handleDownload = () => {
    const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName.replace(/\.(txt|lua)$/, '') + '_decrypted.lua';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(output);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      alert('Gagal menyalin ke clipboard');
    }
  };

  const handleClear = () => {
    setOutput('');
    setError('');
    setCopied(false);
    setFileName('');
    setFileSize(0);
    setDecryptInfo(null);
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const formatBytes = (bytes) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8 pt-8">
          <div className="flex items-center justify-center mb-4">
            <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-3 rounded-2xl shadow-lg shadow-purple-500/50">
              <Unlock className="w-8 h-8 text-white" />
            </div>
          </div>
          <h1 className="text-4xl font-bold text-white mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
            Lua Decrypt Tool
          </h1>
          <p className="text-purple-300 text-sm">Yasu Encryption Decryptor - Untuk File Besar</p>
        </div>

        {/* Main Card */}
        <div className="bg-slate-800/50 backdrop-blur-lg rounded-2xl shadow-2xl border border-purple-500/20 overflow-hidden">
          {/* File Upload Section */}
          <div className="p-6">
            <label className="flex items-center text-purple-300 font-semibold mb-3">
              <Upload className="w-4 h-4 mr-2" />
              Upload File Script Terenkripsi
            </label>
            <div className="relative">
              <input
                ref={fileInputRef}
                type="file"
                accept=".txt,.lua,.luac,text/*"
                onChange={handleFileUpload}
                className="hidden"
                id="file-upload"
                disabled={processing}
              />
              <label
                htmlFor="file-upload"
                className={`flex items-center justify-center gap-3 w-full bg-slate-900/50 border-2 border-dashed ${
                  processing ? 'border-purple-400 cursor-wait' : 'border-purple-500/50 hover:border-purple-400 cursor-pointer'
                } rounded-xl p-8 transition-all group`}
              >
                <div className="text-center">
                  <FileText className={`w-16 h-16 text-purple-400 mx-auto mb-3 ${!processing && 'group-hover:scale-110'} transition-transform`} />
                  {processing ? (
                    <>
                      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400 mx-auto mb-2"></div>
                      <p className="text-purple-300 font-semibold">Memproses file...</p>
                    </>
                  ) : fileName ? (
                    <>
                      <p className="text-purple-300 font-semibold mb-1">
                        ðŸ“„ {fileName}
                      </p>
                      <p className="text-purple-400/70 text-sm">
                        {formatBytes(fileSize)}
                      </p>
                      <p className="text-purple-500 text-xs mt-2">
                        Klik lagi untuk ganti file
                      </p>
                    </>
                  ) : (
                    <>
                      <p className="text-purple-300 font-semibold mb-1">
                        Klik untuk pilih file
                      </p>
                      <p className="text-purple-400/70 text-sm">
                        Format: .txt, .lua (Support file besar)
                      </p>
                    </>
                  )}
                </div>
              </label>
            </div>

            {/* Info Alert */}
            <div className="mt-4 bg-blue-900/30 border border-blue-500/50 rounded-xl p-4">
              <p className="text-blue-300 text-sm">
                ðŸ’¡ <strong>Tip:</strong> Tool ini bisa handle file besar tanpa masalah paste! Upload langsung file .lua atau .txt Anda.
              </p>
            </div>
          </div>

          {/* Error Message */}
          {error && (
            <div className="mx-6 mb-6 bg-red-900/30 border border-red-500/50 rounded-xl p-4 flex items-start gap-3">
              <AlertCircle className="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" />
              <div>
                <p className="text-red-300 font-semibold">Error</p>
                <p className="text-red-200 text-sm">{error}</p>
              </div>
            </div>
          )}

          {/* Success Output */}
          {output && (
            <>
              {/* Info Stats */}
              {decryptInfo && (
                <div className="mx-6 mb-4 grid grid-cols-2 gap-3">
                  <div className="bg-purple-900/30 border border-purple-500/30 rounded-lg p-3">
                    <p className="text-purple-400 text-xs mb-1">Input Size</p>
                    <p className="text-white font-semibold">{formatBytes(decryptInfo.inputSize)}</p>
                  </div>
                  <div className="bg-green-900/30 border border-green-500/30 rounded-lg p-3">
                    <p className="text-green-400 text-xs mb-1">Output Size</p>
                    <p className="text-white font-semibold">{formatBytes(decryptInfo.outputSize)}</p>
                  </div>
                  <div className="bg-blue-900/30 border border-blue-500/30 rounded-lg p-3">
                    <p className="text-blue-400 text-xs mb-1">Key Length</p>
                    <p className="text-white font-semibold">{decryptInfo.keyLength} chars</p>
                  </div>
                  <div className="bg-pink-900/30 border border-pink-500/30 rounded-lg p-3">
                    <p className="text-pink-400 text-xs mb-1">Encrypted Data</p>
                    <p className="text-white font-semibold">{decryptInfo.dataCount.toLocaleString()} bytes</p>
                  </div>
                </div>
              )}

              {/* Action Buttons */}
              <div className="px-6 pb-4 flex gap-3">
                <button
                  onClick={handleDownload}
                  className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-semibold py-3 px-6 rounded-xl transition-all transform hover:scale-105 active:scale-95 shadow-lg shadow-green-500/30 flex items-center justify-center gap-2"
                >
                  <Download className="w-5 h-5" />
                  Download Hasil
                </button>
                <button
                  onClick={handleCopy}
                  className="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-2"
                >
                  {copied ? (
                    <>
                      <Check className="w-5 h-5" />
                      Tersalin!
                    </>
                  ) : (
                    <>
                      <Copy className="w-5 h-5" />
                      Copy
                    </>
                  )}
                </button>
                <button
                  onClick={handleClear}
                  className="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl transition-all"
                >
                  Clear
                </button>
              </div>

              {/* Output Preview */}
              <div className="px-6 pb-6">
                <label className="text-purple-300 font-semibold flex items-center mb-3">
                  <Check className="w-4 h-4 mr-2" />
                  Preview Hasil (Scroll untuk lihat semua)
                </label>
                <div className="bg-slate-900/50 border border-green-500/30 rounded-xl p-4 max-h-96 overflow-y-auto">
                  <pre className="text-green-300 text-xs font-mono whitespace-pre-wrap break-words leading-relaxed">
                    {output.substring(0, 5000)}{output.length > 5000 && '\n\n... (File terlalu panjang, gunakan tombol Download untuk lihat semua)'}
                  </pre>
                </div>
              </div>
            </>
          )}
        </div>

        {/* Footer Info */}
        <div className="mt-6 text-center text-purple-300/70 text-sm space-y-2">
          <p>âœ¨ Tool untuk mendekripsi script Lua yang dienkripsi dengan Yasu Encryption</p>
          <p>ðŸš€ Support file besar - Upload langsung tanpa perlu copy paste!</p>
        </div>
      </div>
    </div>
  );
}